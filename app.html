<!DOCTYPE html>
<html lang="zh-TW">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=5.0, user-scalable=yes, viewport-fit=cover">
<meta name="mobile-web-app-capable" content="yes">
<meta name="apple-mobile-web-app-capable" content="yes">
<meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
<meta name="theme-color" content="#13161f">
<link rel="manifest" href="manifest.json">
<link rel="apple-touch-icon" href="data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 192 192'%3E%3Crect fill='%230e1117' width='192' height='192'/%3E%3Ctext x='96' y='140' font-size='120' text-anchor='middle' fill='%23c9a84c'%3Eâ—ˆ%3C/text%3E%3C/svg%3E">
<title>AURUM è³‡ç”¢è¿½è¹¤</title>
<script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.min.js"></script>
<script>
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  è¨­å‚™åµæ¸¬èˆ‡è‡ªå‹•é©é…
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
(function(){
  // æª¢æŸ¥ç”¨æˆ¶æ‰‹å‹•è¨­å®šçš„æ¨¡å¼
  const forceMode = localStorage.getItem('forceViewMode');
  
  // åµæ¸¬è¨­å‚™é¡å‹
  const isMobile = /Android|webOS|iPhone|iPad|iPod|BlackBerry|IEMobile|Opera Mini/i.test(navigator.userAgent);
  const isTablet = /iPad|Android/i.test(navigator.userAgent) && window.innerWidth >= 768;
  const isSmallScreen = window.innerWidth <= 768;
  
  // å¼·åˆ¶è¨­å®š viewportï¼ˆä¿®æ­£æŸäº›ç€è¦½å™¨å•é¡Œï¼‰
  function setViewport() {
    let viewport = document.querySelector('meta[name=viewport]');
    if (!viewport) {
      viewport = document.createElement('meta');
      viewport.name = 'viewport';
      document.head.appendChild(viewport);
    }
    
    // ç§»é™¤èˆŠçš„ class
    document.documentElement.classList.remove('is-mobile','is-tablet','is-desktop');
    
    // å„ªå…ˆä½¿ç”¨ç”¨æˆ¶è¨­å®š
    if (forceMode === 'mobile') {
      viewport.content = 'width=device-width, initial-scale=1.0, maximum-scale=5.0, user-scalable=yes, viewport-fit=cover';
      document.documentElement.classList.add('is-mobile');
    } else if (forceMode === 'desktop') {
      viewport.content = 'width=device-width, initial-scale=1.0';
      document.documentElement.classList.add('is-desktop');
    } else {
      // è‡ªå‹•åµæ¸¬
      if (isMobile || isSmallScreen) {
        viewport.content = 'width=device-width, initial-scale=1.0, maximum-scale=5.0, user-scalable=yes, viewport-fit=cover';
        document.documentElement.classList.add('is-mobile');
      } else if (isTablet) {
        viewport.content = 'width=device-width, initial-scale=1.0, maximum-scale=5.0, user-scalable=yes';
        document.documentElement.classList.add('is-tablet');
      } else {
        viewport.content = 'width=device-width, initial-scale=1.0';
        document.documentElement.classList.add('is-desktop');
      }
    }
  }
  
  setViewport();
  
  // è¦–çª—å¤§å°æ”¹è®Šæ™‚é‡æ–°åµæ¸¬ï¼ˆä½†å°Šé‡ç”¨æˆ¶è¨­å®šï¼‰
  window.addEventListener('resize', function(){
    if(!forceMode){
      setViewport();
    }
  });
  
  // å„²å­˜è¨­å‚™è³‡è¨Šä¾›å¾ŒçºŒä½¿ç”¨
  window.deviceInfo = {
    isMobile: isMobile || isSmallScreen,
    isTablet: isTablet,
    isDesktop: !isMobile && !isSmallScreen,
    width: window.innerWidth,
    height: window.innerHeight,
    userAgent: navigator.userAgent,
    forceMode: forceMode
  };
  
  console.log('ğŸ“± è¨­å‚™è³‡è¨Š:', window.deviceInfo);
  
  // é é¢è¼‰å…¥å®Œæˆå¾Œæ›´æ–°åœ–ç¤º
  window.addEventListener('load', function(){
    setTimeout(function(){
      if(window.updateViewModeIcon){
        window.updateViewModeIcon();
      }
    }, 100);
  });
})();
</script>
<style>
/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   æ¨£å¼å€ (STYLES) - å®Œæ•´ CSSï¼Œå¾ˆå°‘éœ€è¦ä¿®æ”¹
   â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
*,*::before,*::after{box-sizing:border-box;margin:0;padding:0}

/* éŸ¿æ‡‰å¼å­—é«”ç³»çµ± - æ ¹æ“šè¦–çª—å¯¬åº¦è‡ªå‹•ç¸®æ”¾ */
html{
  /* åŸºç¤å­—é«”ï¼šæ‰‹æ©Ÿ 14px â†’ æ¡Œé¢ 16px */
  font-size:clamp(14px, 3.5vw, 16px);
}
@media(min-width:768px){
  html{font-size:clamp(14px, 1.2vw, 16px);}
}
@media(min-width:1200px){
  html{font-size:16px;}
}

html,body{
  height:100%;
  background:#0e1117;
  color:#e8e0d0;
  font-family:-apple-system,BlinkMacSystemFont,"Segoe UI","Noto Sans",Helvetica,Arial,sans-serif,"Apple Color Emoji","Segoe UI Emoji";
}

/* ä½¿ç”¨ rem æ›¿ä»£ pxï¼Œè‡ªå‹•éš¨è¦–çª—ç¸®æ”¾ */
::-webkit-scrollbar{width:0.3rem;height:0.3rem}
::-webkit-scrollbar-track{background:#1a1e28}
::-webkit-scrollbar-thumb{background:#c9a84c44;border-radius:0.2rem}

/* å¼·åˆ¶æ‰‹æ©Ÿç‰ˆå¸ƒå±€ */
html.is-mobile .nav-bar{display:none !important}
html.is-mobile .mobile-nav{display:flex !important}
html.is-mobile .rename-btn{display:none !important}
html.is-mobile .content{padding:1rem 1rem 5.6rem !important}
html.is-mobile .stats-grid{grid-template-columns:1fr 1fr !important}
html.is-mobile .holdings-grid{grid-template-columns:1fr !important}

/* æ‰‹æ©Ÿç‰ˆå­—é«”æ”¾å¤§ */
html.is-mobile body{font-size:clamp(15px, 4vw, 18px) !important}
html.is-mobile .stat-label{font-size:clamp(0.8rem, 3vw, 1rem) !important}
html.is-mobile .stat-value{font-size:clamp(1.1rem, 4.5vw, 1.4rem) !important}
html.is-mobile .card-title{font-size:clamp(1rem, 3.8vw, 1.2rem) !important}
html.is-mobile .btn{font-size:clamp(1rem, 3.8vw, 1.1rem) !important}
html.is-mobile .input{font-size:clamp(1rem, 3.8vw, 1.1rem) !important}
html.is-mobile .tag{font-size:clamp(0.8rem, 3vw, 1rem) !important}
html.is-mobile .hc-symbol{font-size:clamp(1.1rem, 4.2vw, 1.3rem) !important}
html.is-mobile .hc-name{font-size:clamp(0.8rem, 3vw, 1rem) !important}
html.is-mobile .hc-label{font-size:clamp(0.75rem, 2.8vw, 0.9rem) !important}
html.is-mobile .hc-value{font-size:clamp(1rem, 3.8vw, 1.1rem) !important}
html.is-mobile .h-sub{font-size:clamp(0.85rem, 3.2vw, 1rem) !important}
html.is-mobile .h-date{font-size:clamp(0.75rem, 2.8vw, 0.9rem) !important}
html.is-mobile .price-bar-info{font-size:clamp(0.85rem, 3.2vw, 1rem) !important}
html.is-mobile .modal-title{font-size:clamp(1.1rem, 4.2vw, 1.3rem) !important}
html.is-mobile .field-label{font-size:clamp(0.85rem, 3.2vw, 1rem) !important}
html.is-mobile .nav-tab{font-size:clamp(0.9rem, 3.5vw, 1.1rem) !important}
html.is-mobile .wallet-tab{font-size:clamp(0.85rem, 3.2vw, 1rem) !important}
html.is-mobile .logo-text{font-size:clamp(1rem, 4vw, 1.2rem) !important}
html.is-mobile .logo-sub{font-size:clamp(0.75rem, 2.8vw, 0.9rem) !important}
html.is-mobile .db-badge{font-size:clamp(0.85rem, 3.2vw, 1rem) !important}
html.is-mobile .empty{font-size:clamp(1rem, 3.8vw, 1.1rem) !important}
#startupScreen{position:fixed;inset:0;background:#0e1117;z-index:500;display:flex;align-items:center;justify-content:center;padding:24px}
.startup-card{background:#1a1e28;border:1px solid #2a2e3e;border-radius:1.25rem;padding:36px 32px;width:100%;max-width:26rem}
.startup-logo{display:flex;align-items:center;gap:0.75rem;margin-bottom:28px}
.startup-logo-icon{width:40px;height:40px;background:linear-gradient(135deg,#c9a84c,#8b6914);border-radius:10px;display:flex;align-items:center;justify-content:center;font-size:20px}
.startup-logo-text{font-size:20px;font-weight:bold;letter-spacing:.08em}.startup-logo-sub{font-size:12px;color:#555;letter-spacing:.12em}
.startup-title{font-size:13px;color:#888;margin-bottom:18px;display:flex;align-items:center;gap:0.5rem}
.scan-row{display:flex;align-items:center;justify-content:space-between;padding:11px 0;border-bottom:1px solid #161a24;animation:fadeSlide .3s ease both}
.scan-row:last-child{border-bottom:none}@keyframes fadeSlide{from{opacity:0;transform:translateX(-8px)}to{opacity:1;transform:none}}
.scan-label{font-size:13px;color:#aaa;display:flex;align-items:center;gap:0.5rem}
.scan-badge{font-size:12px;padding:3px 10px;border-radius:1.25rem;white-space:nowrap}
.sb-waiting{background:#1e2230;color:#555}.sb-ok{background:#1a3a2a;color:#4caf82}.sb-created{background:#1a2a3a;color:#7ab8d4}.sb-empty{background:#2a2a1a;color:#c9a84c}
.startup-summary{margin-top:20px;padding:0.9rem 16px;background:#0e1117;border-radius:10px;border:1px solid #2a2e3e;display:none}
.startup-summary.show{display:block}.ss-stats{display:flex;gap:0.65rem;margin-top:8px}.ss-stat{flex:1;text-align:center}
.ss-val{font-size:18px;color:#c9a84c;font-weight:bold}.ss-lbl{font-size:12px;color:#555;margin-top:3px}
.startup-action{margin-top:20px;display:none}.startup-msg{font-size:12px;color:#555;margin-top:12px;text-align:center;min-height:18px}
.startup-spinner{width:14px;height:14px;border:2px solid #2a2e3e;border-top-color:#c9a84c;border-radius:50%;animation:spin .7s linear infinite;flex-shrink:0}
#app{display:flex;flex-direction:column;min-height:100vh}
.header{background:#13161f;border-bottom:1px solid #2a2e3e;padding:0.75rem 24px;display:flex;align-items:center;justify-content:space-between;flex-shrink:0}
.logo{display:flex;align-items:center;gap:0.65rem}
.logo-icon{width:30px;height:30px;background:linear-gradient(135deg,#c9a84c,#8b6914);border-radius:0.5rem;display:flex;align-items:center;justify-content:center;font-size:15px;flex-shrink:0}
.logo-text{font-size:15px;font-weight:bold;letter-spacing:.08em;line-height:1.2}.logo-sub{font-size:12px;color:#555;letter-spacing:.12em}
.db-badge{display:flex;align-items:center;gap:0.4rem;font-size:12px;color:#888;cursor:pointer;padding:4px 10px;border-radius:1.25rem;border:1px solid #2a2e3e;transition:all .2s}
.db-badge:hover{border-color:#c9a84c44;color:#c9a84c}
.dot{width:8px;height:8px;border-radius:50%;flex-shrink:0;background:#555}.dot-green{background:#4caf82!important}.dot-gold{background:#c9a84c!important;animation:blink .8s ease-in-out infinite}
@keyframes blink{0%,100%{opacity:1}50%{opacity:.2}}
.wallet-bar{background:#13161f;padding:0.75rem 24px 0;display:flex;align-items:flex-end;gap:4px;overflow-x:auto;flex-shrink:0}
.wallet-tab{cursor:pointer;padding:0.5rem 0.9rem;border-radius:0.5rem 8px 0 0;font-size:13px;border:1px solid #2a2e3e;border-bottom:none;white-space:nowrap;flex-shrink:0;font-family:-apple-system,BlinkMacSystemFont,"Segoe UI","Noto Sans",Helvetica,Arial,sans-serif;background:#13161f;color:#888;transition:all .2s}
.wallet-tab.active{background:#1a1e28;color:#c9a84c;border-color:#c9a84c44}.wallet-del{margin-left:8px;color:#ff6b6b;font-size:12px}
.nav-bar{background:#1a1e28;border-bottom:1px solid #2a2e3e;padding:0 24px;display:flex;align-items:center;min-height:50px;gap:4px;flex-shrink:0}
.nav-tab{cursor:pointer;padding:0.5rem 1rem;font-size:13px;border-radius:1.25rem;border:none;background:transparent;color:#888;font-family:-apple-system,BlinkMacSystemFont,"Segoe UI","Noto Sans",Helvetica,Arial,sans-serif;transition:all .2s}
.nav-tab.active{background:#c9a84c22;color:#c9a84c}
.nav-right{margin-left:auto;display:flex;align-items:center;gap:0.5rem}
.hdr-btn{background:transparent;border:1px solid #2a2e3e;color:#aaa;padding:0.4rem 0.75rem;border-radius:0.5rem;cursor:pointer;font-size:12px;font-family:-apple-system,BlinkMacSystemFont,"Segoe UI","Noto Sans",Helvetica,Arial,sans-serif;transition:all .2s;white-space:nowrap}
.hdr-btn:hover{border-color:#c9a84c44;color:#c9a84c}.hdr-btn:disabled{opacity:.4;cursor:not-allowed}
.hdr-btn.has-changes{background:#c9a84c22;border-color:#c9a84c;color:#c9a84c;animation:pulse 1.5s ease-in-out infinite}
@keyframes pulse{0%,100%{opacity:1}50%{opacity:.6}}
.content{padding:24px;max-width:1100px;margin:0 auto;width:100%;flex:1}
.card{background:#1a1e28;border:1px solid #2a2e3e;border-radius:0.75rem;padding:1.25rem;margin-bottom:16px}
.card-title{font-size:14px;color:#c9a84c;margin-bottom:16px}
.stats-grid{display:grid;grid-template-columns:repeat(4,1fr);gap:0.75rem;margin-bottom:20px}
.stat-card{background:#1a1e28;border:1px solid #2a2e3e;border-radius:0.75rem;padding:16px}
.stat-label{font-size:12px;color:#888;margin-bottom:6px}.stat-value{font-size:18px;letter-spacing:-.3px;word-break:break-all}
.gold{color:#c9a84c}.green{color:#4caf82}.red{color:#f06060}
.action-bar{display:flex;gap:0.65rem;margin-bottom:20px;flex-wrap:wrap}
.btn{cursor:pointer;border:none;border-radius:0.5rem;padding:0.65rem 1.15rem;font-size:0.85rem;font-family:-apple-system,BlinkMacSystemFont,"Segoe UI","Noto Sans",Helvetica,Arial,sans-serif;transition:all .2s}
.btn-gold{background:#c9a84c;color:#0e1117;font-weight:bold}.btn-gold:hover{background:#e8d5a3}.btn-gold:disabled{opacity:.4;cursor:not-allowed}
.btn-ghost{background:transparent;border:1px solid #2a2e3e;color:#aaa}.btn-ghost:hover{border-color:#c9a84c44;color:#c9a84c}
.btn-del{background:transparent;border:1px solid #ff4d4d44;color:#ff6b6b;padding:6px 10px;border-radius:6px;cursor:pointer;font-size:14px;flex-shrink:0}
.btn-del:hover{background:#ff4d4d22}
.tag{display:inline-block;padding:3px 9px;border-radius:1.25rem;font-size:12px;white-space:nowrap}
.tag-us{background:#1a3a5c;color:#7ab8d4}.tag-tw{background:#3a1a1a;color:#d47a7a}.tag-crypto{background:#2a1a3a;color:#b47ad4}
.tag-in{background:#1a3a2a;color:#4caf82}.tag-out{background:#3a1a1a;color:#f06060}
.tag-buy{background:#1a3a2a;color:#4caf82}.tag-sell{background:#3a1a1a;color:#f06060}.tag-pending{background:#2a2a1a;color:#c9a84c;border:1px solid #c9a84c44}
.holdings-grid{display:grid;grid-template-columns:repeat(auto-fill,minmax(320px,1fr));gap:0.75rem}
.holding-card{background:#13161f;border:1px solid #2a2e3e;border-radius:0.75rem;padding:1rem;transition:all .2s;position:relative}
.holding-card:hover{border-color:#c9a84c44}.holding-card.pending{border-color:#c9a84c44;background:#1a1e1f}
.hc-header{display:flex;align-items:flex-start;justify-content:space-between;margin-bottom:12px;gap:0.65rem}
.hc-symbol{font-size:18px;font-weight:bold;color:#e8e0d0}.hc-name{font-size:12px;color:#666;margin-top:2px}
.hc-tags{display:flex;gap:4px;flex-wrap:wrap;flex-shrink:0}
.hc-body{display:grid;grid-template-columns:1fr 1fr;gap:0.65rem 16px;margin-bottom:12px}
.hc-field{display:flex;flex-direction:column;gap:2px}
.hc-label{font-size:12px;color:#666;text-transform:uppercase;letter-spacing:.05em}.hc-value{font-size:14px;color:#e8e0d0}
.hc-footer{display:flex;justify-content:flex-end;padding-top:8px;border-top:1px solid #1e2230}
.sym-wrap{position:relative}.sym-input-row{display:flex;gap:0.5rem;align-items:center}.sym-input-row .input{flex:1}
.sym-search-btn{flex-shrink:0;background:#c9a84c22;border:1px solid #c9a84c44;color:#c9a84c;padding:10px 14px;border-radius:0.5rem;cursor:pointer;font-size:13px;font-family:-apple-system,BlinkMacSystemFont,"Segoe UI","Noto Sans",Helvetica,Arial,sans-serif;transition:all .2s;white-space:nowrap}
.sym-search-btn:hover{background:#c9a84c33}.sym-search-btn:disabled{opacity:.4;cursor:not-allowed}
.sym-dropdown{background:#13161f;border:1px solid #c9a84c44;border-radius:10px;margin-top:6px;overflow:hidden}
.sym-item{display:flex;align-items:center;justify-content:space-between;padding:0.75rem 14px;cursor:pointer;transition:background .15s;gap:0.65rem}
.sym-item:hover{background:#1a1e28}.sym-item-left{display:flex;align-items:center;gap:0.65rem;min-width:0}
.sym-item-symbol{font-weight:bold;font-size:14px;color:#e8e0d0;flex-shrink:0}
.sym-item-name{font-size:12px;color:#888;white-space:nowrap;overflow:hidden;text-overflow:ellipsis}
.sym-item-right{display:flex;align-items:center;gap:0.5rem;flex-shrink:0}.sym-item-price{font-size:12px;color:#c9a84c}
.sym-no-result{padding:16px 14px;color:#555;font-size:13px;text-align:center}
.sym-status{min-height:20px;display:flex;align-items:center;gap:0.5rem;font-size:12px;color:#888;margin-top:6px}
.sym-selected{background:#0e1117;border:1px solid #c9a84c44;border-radius:0.5rem;padding:10px 14px;margin-top:6px;display:flex;align-items:center;justify-content:space-between;gap:0.65rem}
.sym-selected-info{display:flex;align-items:center;gap:0.5rem;min-width:0}
.sym-clear{background:transparent;border:none;color:#666;cursor:pointer;font-size:16px;flex-shrink:0;padding:0 4px}.sym-clear:hover{color:#f06060}
.history-item{display:flex;align-items:center;justify-content:space-between;padding:0.9rem 0;border-bottom:1px solid #1e2230;gap:0.65rem;position:relative}
.history-item:last-child{border-bottom:none}.history-item.pending{background:#1a1e1f22}
.h-icon{width:38px;height:38px;background:#0e1117;border-radius:0.5rem;display:flex;align-items:center;justify-content:center;font-size:17px;flex-shrink:0}
.h-left{display:flex;align-items:center;gap:0.65rem;flex:1;min-width:0}
.h-sub{font-size:12px;color:#666;margin-top:3px}.h-date{font-size:12px;color:#444;margin-top:2px}
.h-right{display:flex;align-items:center;gap:0.75rem;flex-shrink:0}.h-twd{font-size:12px;color:#555}
.price-bar{display:flex;align-items:center;justify-content:space-between;background:#1a1e28;border:1px solid #2a2e3e;border-radius:10px;padding:10px 16px;margin-bottom:16px;gap:0.75rem;flex-wrap:wrap}
.price-bar-info{display:flex;align-items:center;gap:0.5rem;font-size:12px;color:#888}
.modal-bg{position:fixed;inset:0;background:#000000cc;display:flex;align-items:center;justify-content:center;z-index:200;padding:16px}
.modal{background:#1a1e28;border:1px solid #c9a84c44;border-radius:16px;padding:24px;width:100%;max-width:480px;max-height:92vh;overflow-y:auto}
.modal-title{font-size:16px;color:#c9a84c;margin-bottom:20px}
.field{margin-bottom:14px}.field-label{font-size:12px;color:#888;margin-bottom:6px}
.input{background:#0e1117;border:1px solid #2a2e3e;border-radius:0.5rem;padding:10px 14px;color:#e8e0d0;font-size:14px;font-family:-apple-system,BlinkMacSystemFont,"Segoe UI","Noto Sans",Helvetica,Arial,sans-serif;width:100%;outline:none;transition:border .2s}
.input:focus{border-color:#c9a84c66}
.grid-2{display:grid;grid-template-columns:1fr 1fr;gap:0.75rem}
.toggle-row{display:flex;background:#0e1117;border-radius:0.5rem;padding:4px;gap:4px;margin-bottom:14px}
.toggle-btn{flex:1;padding:9px;border:none;border-radius:6px;cursor:pointer;font-family:-apple-system,BlinkMacSystemFont,"Segoe UI","Noto Sans",Helvetica,Arial,sans-serif;font-size:13px;background:transparent;color:#888;transition:all .2s}
.toggle-btn.active-buy{background:#1a3a2a;color:#4caf82;font-weight:bold}.toggle-btn.active-sell{background:#3a1a1a;color:#f06060;font-weight:bold}
.preview-box{background:#0e1117;border-radius:0.5rem;padding:0.75rem;font-size:13px;margin-bottom:14px}
.modal-actions{display:flex;gap:0.65rem;margin-top:4px}
.spinner{width:14px;height:14px;border:2px solid #2a2e3e;border-top-color:#c9a84c;border-radius:50%;animation:spin .7s linear infinite;flex-shrink:0}
.spinner-lg{width:28px;height:28px;border:3px solid #2a2e3e;border-top-color:#c9a84c;border-radius:50%;animation:spin .8s linear infinite}
@keyframes spin{to{transform:rotate(360deg)}}
.db-detail{background:#1a1e28;border:1px solid #c9a84c44;border-radius:16px;padding:24px;width:100%;max-width:400px}
.db-detail-row{display:flex;align-items:center;justify-content:space-between;padding:10px 0;border-bottom:1px solid #1e2230}.db-detail-row:last-child{border-bottom:none}
.db-badge-ok{background:#1a3a2a;color:#4caf82;padding:3px 10px;border-radius:1.25rem;font-size:12px}
.db-badge-rows{background:#1a2030;color:#7ab8d4;padding:3px 10px;border-radius:1.25rem;font-size:12px}
.mobile-nav{display:none;position:fixed;bottom:0;left:0;right:0;background:#13161f;border-top:1px solid #2a2e3e;z-index:100;padding:6px 0}
.mobile-nav-btn{flex:1;display:flex;flex-direction:column;align-items:center;gap:2px;cursor:pointer;padding:6px 2px;border:none;background:transparent;color:#666;font-size:12px;font-family:-apple-system,BlinkMacSystemFont,"Segoe UI","Noto Sans",Helvetica,Arial,sans-serif}
.mobile-nav-btn.active{color:#c9a84c}.mobile-nav-icon{font-size:1.5rem;line-height:1}
.empty{color:#444;text-align:center;padding:40px 20px;font-size:14px}.empty-icon{font-size:36px;margin-bottom:12px}
.toast{position:fixed;bottom:80px;left:50%;transform:translateX(-50%);background:#1a1e28;border:1px solid #c9a84c44;color:#e8e0d0;padding:10px 20px;border-radius:1.25rem;font-size:13px;z-index:600;animation:fadeUp .2s ease;white-space:nowrap;pointer-events:none}
@keyframes fadeUp{from{opacity:0;transform:translate(-50%,8px)}to{opacity:1;transform:translate(-50%,0)}}
@keyframes fadeIn{from{opacity:0;transform:translateY(6px)}to{opacity:1;transform:none}}.fade-in{animation:fadeIn .25s ease}
@media(max-width:768px){
  .nav-bar{display:none}
  .mobile-nav{display:flex}
  .content{padding:16px 16px 90px}
  .stats-grid{grid-template-columns:1fr 1fr;gap:0.65rem}
  .stat-label{font-size:13px}
  .stat-value{font-size:18px}
  .card{padding:0.9rem}
  .card-title{font-size:16px}
  .rename-btn{display:none}
  .header{padding:0.75rem 16px}
  .wallet-bar{padding:0.75rem 16px 0;gap:0.4rem}
  .wallet-tab{padding:6px 10px;font-size:14px}
  .startup-card{padding:24px 20px}
  .holdings-grid{grid-template-columns:1fr}
  
  /* æ”¹é€²è§¸æ§é«”é©— */
  .btn{padding:0.75rem 20px;font-size:16px;min-height:44px}
  .btn-gold,.btn-ghost{touch-action:manipulation}
  .hdr-btn{padding:0.5rem 0.9rem;min-height:40px;font-size:14px}
  .btn-del{padding:8px 12px;min-height:40px;font-size:16px}
  
  /* Modal å„ªåŒ– */
  .modal{padding:1.25rem;max-height:85vh;max-width:95vw}
  .modal-title{font-size:18px}
  .input{padding:0.75rem 14px;font-size:16px;min-height:44px}
  .toggle-btn{padding:10px;min-height:44px;font-size:16px}
  .field-label{font-size:14px}
  
  /* å¡ç‰‡å„ªåŒ– */
  .holding-card{padding:0.9rem}
  .hc-symbol{font-size:18px}
  .hc-name{font-size:13px}
  .hc-body{gap:0.5rem 12px}
  .hc-label{font-size:12px}
  .hc-value{font-size:16px}
  .hc-footer{font-size:12px}
  
  /* æ­·å²ç´€éŒ„å„ªåŒ– */
  .history-item{padding:0.75rem 0;gap:0.5rem}
  .h-icon{width:2.125rem;height:2.125rem;font-size:0.95rem}
  .h-sub{font-size:14px}
  .h-date{font-size:12px}
  .h-twd{font-size:12px}
  
  /* é¸è‚¡ä¸‹æ‹‰å„ªåŒ– */
  .sym-dropdown{max-height:50vh;overflow-y:auto}
  .sym-item{padding:0.9rem 12px}
  .sym-item-symbol{font-size:16px}
  .sym-item-name{font-size:13px}
  .sym-item-price{font-size:14px}
  .sym-no-result{font-size:15px}
  .sym-status{font-size:14px}
  
  /* åƒ¹æ ¼æ¬„å„ªåŒ– */
  .price-bar{flex-direction:column;align-items:stretch;gap:0.5rem}
  .price-bar-info{justify-content:center;font-size:14px}
  .price-bar .btn-ghost{width:100%;font-size:14px}
  
  /* Tag å„ªåŒ– */
  .tag{font-size:13px;padding:4px 10px}
  
  /* Toast ä½ç½®èª¿æ•´ */
  .toast{bottom:100px;max-width:90vw;white-space:normal;text-align:center;font-size:15px}
  
  /* å°èˆªæ¬„å­—é«” */
  .nav-tab{font-size:15px}
  .mobile-nav-btn{font-size:12px}
  .mobile-nav-icon{font-size:22px}
  
  /* Logo å„ªåŒ– */
  .logo-text{font-size:17px}
  .logo-sub{font-size:12px}
  
  /* DB Badge */
  .db-badge{font-size:14px}
  
  /* Empty ç‹€æ…‹ */
  .empty{font-size:16px}
  .empty-icon{font-size:40px}
  
  /* é˜²æ­¢æ°´å¹³æ»¾å‹• */
  body,html{overflow-x:hidden}
  .stat-value{word-break:break-all}
  .hc-value{word-break:break-word}
}

/* å°è¢å¹•æ‰‹æ©Ÿå„ªåŒ– (iPhone SE, small Android) - å­—é«”ä¸èƒ½å†å°äº† */
@media(max-width:375px){
  body{font-size:16px}
  .stats-grid{grid-template-columns:1fr;gap:0.5rem}
  .stat-card{padding:0.75rem}
  .stat-label{font-size:13px}
  .stat-value{font-size:17px}
  .card-title{font-size:15px}
  .action-bar{gap:0.5rem}
  .btn{padding:10px 16px;font-size:15px}
  .modal{padding:16px}
  .modal-title{font-size:17px}
  .holdings-grid{gap:0.65rem}
  .holding-card{padding:0.75rem}
  .hc-symbol{font-size:17px}
  .hc-name{font-size:12px}
  .hc-label{font-size:12px}
  .hc-value{font-size:15px}
  .wallet-tab{font-size:13px;padding:5px 8px}
  .tag{font-size:12px}
  .input{font-size:16px}
  .field-label{font-size:13px}
}

/* å¹³æ¿å„ªåŒ– */
@media(min-width:769px) and (max-width:1024px){
  .content{max-width:900px}
  .holdings-grid{grid-template-columns:repeat(2,1fr)}
  .stats-grid{grid-template-columns:repeat(4,1fr)}
}

/* æ©«å±æ‰‹æ©Ÿå„ªåŒ– */
@media(max-height:500px) and (orientation:landscape){
  .startup-card{padding:16px;max-height:90vh;overflow-y:auto}
  .modal{max-height:90vh;padding:16px}
  .content{padding:0.75rem 16px 70px}
  .mobile-nav{padding:4px 0}
  .mobile-nav-btn{padding:4px 2px;font-size:12px}
  .mobile-nav-icon{font-size:16px}
}
</style>
</head>
<body>

<div id="startupScreen">
  <div class="startup-card">
    <div class="startup-logo">
      <div class="startup-logo-icon">â—ˆ</div>
      <div><div class="startup-logo-text">AURUM</div><div class="startup-logo-sub">è³‡ç”¢è¿½è¹¤</div></div>
    </div>
    <div class="startup-title">
      <div class="startup-spinner" id="startupSpinner"></div>
      <span id="startupTitleText">æ­£åœ¨æƒæè³‡æ–™åº«...</span>
    </div>
    <div id="scanRows"></div>
    <div class="startup-summary" id="startupSummary">
      <div style="font-size:12px;color:#555;letter-spacing:.06em">è³‡æ–™åº«æ‘˜è¦</div>
      <div class="ss-stats" id="startupStats"></div>
    </div>
    <div class="startup-action" id="startupAction">
      <button class="btn btn-gold" style="width:100%" onclick="enterApp()">é€²å…¥ App â†’</button>
    </div>
    <div class="startup-msg" id="startupMsg"></div>
  </div>
</div>

<div id="app" style="display:none">
  <div class="header">
    <div class="logo">
      <div class="logo-icon">â—ˆ</div>
      <div><div class="logo-text">AURUM</div><div class="logo-sub">è³‡ç”¢è¿½è¹¤</div></div>
    </div>
    <div style="display:flex;align-items:center;gap:0.5rem">
      <div class="db-badge" id="dbBadge" onclick="openDbDetail()">
        <div class="dot dot-green" id="dbDot"></div>
        <span id="dbBadgeText">DB å·²é€£ç·š</span>
      </div>
      <button class="db-badge" id="viewModeBtn" onclick="toggleViewMode()" style="cursor:pointer;border:1px solid #2a2e3e;background:#13161f" title="åˆ‡æ›æª¢è¦–æ¨¡å¼">
        <span id="viewModeIcon">ğŸ“±</span>
      </button>
    </div>
  </div>
  <div class="wallet-bar" id="walletBar"></div>
  <div class="nav-bar"    id="navBar"></div>
  <div class="content"    id="mainContent"></div>
  <div class="mobile-nav" id="mobileNav"></div>
</div>

<div id="modalContainer"></div>
<div id="toastContainer"></div>

<script>
/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   æ ¸å¿ƒé‚è¼¯å€ (CORE) - RPCã€ç‹€æ…‹ç®¡ç†ã€è¨ˆç®—å‡½æ•¸
   ä¿®æ”¹é »ç‡ï¼šä¸­ç­‰ï¼ˆæ–°åŠŸèƒ½æ™‚ï¼‰
   â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */

// RPC
function gsr(fn,...args){return new Promise((res,rej)=>google.script.run.withSuccessHandler(res).withFailureHandler(rej)[fn](...args));}

// å¸¸æ•¸
const USD_TWD=32.5;
const TYPE_LBL={us:'ğŸ‡ºğŸ‡¸ ç¾è‚¡',tw:'ğŸ‡¹ğŸ‡¼ å°è‚¡',crypto:'â‚¿ åŠ å¯†è²¨å¹£'};
const DIR_LBL={buy:'è²·å…¥',sell:'è³£å‡º'};
const PIE_COLORS=['#c9a84c','#e8d5a3','#5b8fa8','#3d6b80','#2a4a5e','#8b7355','#a0c4d8','#d4b896','#c9896c','#7ab8d4'];
const SHEET_META={_wallets:{icon:'ğŸ‘›',label:'éŒ¢åŒ…è³‡æ–™è¡¨'},_transactions:{icon:'ğŸ“ˆ',label:'äº¤æ˜“è³‡æ–™è¡¨'},_cashflows:{icon:'ğŸ’°',label:'å‡ºå…¥é‡‘è³‡æ–™è¡¨'},_prices:{icon:'ğŸ“Š',label:'è‚¡åƒ¹è³‡æ–™è¡¨'}};
const SHEETS_ORDER=['_wallets','_transactions','_cashflows','_prices'];

// ç‹€æ…‹
let S={wallets:[],activeWalletId:null,transactions:[],cashFlows:[],prices:{},pendingAddTx:[],pendingDelTx:[],pendingAddFlow:[],pendingDelFlow:[],syncing:false,tab:'overview',priceUpdatedAt:null,priceSource:'',refreshing:false,dbInfo:null,txDirection:'buy',txSelected:null,txSearching:false,txSearchResults:[],txSymbolInput:'',txShares:'',txPrice:'',txFee:'',txBroker:'',txDate:today(),flowForm:{type:'in',amount:'',note:'',isDividend:false,date:today()},renameVal:'',pnlYear:new Date().getFullYear(),pnlMonth:'all',nextRefreshTime:0};
let pieChart=null,appData=null;

// å·¥å…·å‡½æ•¸
function today(){return new Date().toISOString().split('T')[0];}
function toTWD(a,c){return c==='TWD'?a:a*USD_TWD;}
function fmtTWD(n){return 'NT$ '+Math.round(n).toLocaleString();}
function fmtCur(a,c,showCurrency){
  if(a==null||a==='')return 'â€”';
  if(showCurrency===false){
    if(c==='TWD')return 'NT$ '+Number(a).toLocaleString();
    return '$'+Number(a).toLocaleString(undefined,{minimumFractionDigits:2,maximumFractionDigits:2});
  }
  // é è¨­é¡¯ç¤ºå¹£åˆ¥
  if(c==='TWD')return 'NT$ '+Number(a).toLocaleString()+' TWD';
  return '$'+Number(a).toLocaleString(undefined,{minimumFractionDigits:2,maximumFractionDigits:2})+' USD';
}
function esc(s){return String(s||'').replace(/[&<>"']/g,c=>({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'}[c]));}
function hasPendingChanges(){return S.pendingAddTx.length>0||S.pendingDelTx.length>0||S.pendingAddFlow.length>0||S.pendingDelFlow.length>0;}

// è¨ˆç®—å‡½æ•¸
function computeStats(){
  const ti=S.cashFlows.filter(f=>f.type==='in').reduce((s,f)=>s+f.amount,0);
  const to=S.cashFlows.filter(f=>f.type==='out').reduce((s,f)=>s+f.amount,0);
  const iv=S.transactions.reduce((s,t)=>s+toTWD(t.buyPrice*t.shares+(t.fee||0),t.currency),0);
  return{totalIn:ti,totalOut:to,cash:ti-to-iv};
}
function computeHoldings(){
  const map={};
  S.transactions.forEach(t=>{
    if(!map[t.symbol])map[t.symbol]={symbol:t.symbol,name:t.name,type:t.type,currency:t.currency,netShares:0,totalBuyCost:0,totalFees:0,pending:false};
    const dir=t.direction||'buy';
    if(dir==='buy'){
      map[t.symbol].netShares+=t.shares;
      map[t.symbol].totalBuyCost+=t.buyPrice*t.shares;
      map[t.symbol].totalFees+=(t.fee||0);
    }else{
      map[t.symbol].netShares-=t.shares;
    }
    if(t._pending)map[t.symbol].pending=true;
  });
  return Object.values(map).filter(h=>Math.abs(h.netShares)>0.0001);
}
function getPrice(sym){return S.prices[sym]||null;}
function computeTotalMarket(hs){return hs.reduce((s,h)=>{const avgCost=h.netShares>0&&h.totalBuyCost>0?h.totalBuyCost/h.netShares:0;return s+toTWD(avgCost*Math.abs(h.netShares),h.currency);},0);}
function getRecent30(){const d=new Date();d.setDate(d.getDate()-30);return[...S.transactions.filter(t=>new Date(t.date)>=d).map(t=>({...t,_kind:'tx'})),...S.cashFlows.filter(f=>new Date(f.date)>=d).map(f=>({...f,_kind:'flow'}))].sort((a,b)=>new Date(b.date)-new Date(a.date));}

// å•Ÿå‹•
function runStartup(){const rows=document.getElementById('scanRows');rows.innerHTML=SHEETS_ORDER.map((name,i)=>`<div class="scan-row" style="animation-delay:${i*80}ms"><div class="scan-label"><span style="width:22px;text-align:center;display:inline-block">${SHEET_META[name].icon}</span>${SHEET_META[name].label}</div><span class="scan-badge sb-waiting" id="sb_${name}">ç­‰å¾…ä¸­</span></div>`).join('');gsr('initAndLoad').then(data=>{appData=data;const db=data.db;SHEETS_ORDER.forEach((name,i)=>{setTimeout(()=>{const badge=document.getElementById('sb_'+name);if(!badge)return;const info=db.sheets[name];if(!info||!info.exists){badge.className='scan-badge sb-created';badge.textContent='âœ¨ å·²å»ºç«‹';}else if(info.rows===0){badge.className='scan-badge sb-empty';badge.textContent='ç©ºç™½';}else{badge.className='scan-badge sb-ok';badge.textContent=`âœ… ${info.rows} ç­†`;}},i*220+200);});const delay=SHEETS_ORDER.length*220+400;setTimeout(()=>{document.getElementById('startupSpinner').style.display='none';document.getElementById('startupTitleText').textContent=db.isNewInstall?'âœ¨ è³‡æ–™åº«å·²åˆå§‹åŒ–':'âœ… æƒæå®Œæˆ';document.getElementById('startupStats').innerHTML=`<div class="ss-stat"><div class="ss-val">${db.walletCount}</div><div class="ss-lbl">éŒ¢åŒ…</div></div><div class="ss-stat"><div class="ss-val">${db.transactionCount}</div><div class="ss-lbl">äº¤æ˜“</div></div><div class="ss-stat"><div class="ss-val">${db.cashFlowCount}</div><div class="ss-lbl">å‡ºå…¥é‡‘</div></div>`;document.getElementById('startupSummary').classList.add('show');const msg=document.getElementById('startupMsg');msg.textContent=db.isNewInstall?'å·²å»ºç«‹é è¨­ã€Œä¸»å¸³æˆ¶ã€ï¼Œé–‹å§‹è¨˜éŒ„æ‚¨çš„è³‡ç”¢ï¼':`è©¦ç®—è¡¨ï¼š${db.spreadsheetName}`;document.getElementById('startupAction').style.display='block';if(!db.isNewInstall&&db.transactionCount>0){msg.textContent=`è©¦ç®—è¡¨ï¼š${db.spreadsheetName}ã€€Â· 1ç§’å¾Œè‡ªå‹•é€²å…¥`;setTimeout(enterApp,1000);}},delay);}).catch(()=>{document.getElementById('startupSpinner').style.display='none';document.getElementById('startupTitleText').textContent='âš ï¸ é€£ç·šå¤±æ•—';document.getElementById('startupMsg').textContent='è«‹ç¢ºèªæˆæ¬Šå¾Œé‡æ–°æ•´ç†';document.getElementById('startupAction').innerHTML=`<button class="btn btn-ghost" style="width:100%" onclick="location.reload()">ğŸ”„ é‡æ–°æ•´ç†</button>`;document.getElementById('startupAction').style.display='block';});}
function enterApp(){if(!appData){location.reload();return;}S.wallets=appData.wallets;S.activeWalletId=appData.activeWalletId;S.transactions=appData.transactions;S.cashFlows=appData.cashFlows;S.prices=appData.prices;S.dbInfo=appData.db;document.getElementById('startupScreen').style.display='none';document.getElementById('app').style.display='flex';render();}

// è¨ˆç®—å·²å¯¦ç¾æç›Š
function computeRealizedPnL(year,month){
  const txs=[...S.transactions].sort((a,b)=>new Date(a.date)-new Date(b.date));
  const positions={}; // symbol -> [{qty, price, dir}]
  let realized=[];
  
  txs.forEach(t=>{
    if(!positions[t.symbol])positions[t.symbol]=[];
    const dir=t.direction||'buy';
    
    if(dir==='buy'){
      positions[t.symbol].push({qty:t.shares,price:t.buyPrice,date:t.date});
    }else{
      // è³£å‡ºï¼šFIFOé…å°
      let remaining=t.shares;
      const sellPrice=t.buyPrice;
      const sellDate=t.date;
      
      while(remaining>0&&positions[t.symbol].length>0){
        const buy=positions[t.symbol][0];
        const matched=Math.min(remaining,buy.qty);
        const pnl=(sellPrice-buy.price)*matched;
        const pnlTWD=toTWD(pnl,t.currency);
        
        realized.push({
          symbol:t.symbol,
          currency:t.currency,
          qty:matched,
          buyPrice:buy.price,
          sellPrice:sellPrice,
          pnl:pnl,
          pnlTWD:pnlTWD,
          date:sellDate,
          buyDate:buy.date
        });
        
        buy.qty-=matched;
        remaining-=matched;
        if(buy.qty<=0)positions[t.symbol].shift();
      }
    }
  });
  
  // ç¯©é¸å¹´æœˆ
  realized=realized.filter(r=>{
    const d=new Date(r.date);
    if(year&&d.getFullYear()!==parseInt(year))return false;
    if(month&&month!=='all'&&(d.getMonth()+1)!==parseInt(month))return false;
    return true;
  });
  
  const totalPnL=realized.reduce((s,r)=>s+r.pnlTWD,0);
  const wins=realized.filter(r=>r.pnl>0).length;
  const losses=realized.filter(r=>r.pnl<0).length;
  
  return{trades:realized,totalPnL,wins,losses,total:realized.length,winRate:realized.length>0?wins/realized.length*100:0};
}

// è³‡æ–™è¼‰å…¥
function loadWalletData(){gsr('loadWalletData',S.activeWalletId).then(d=>{S.transactions=d.transactions;S.cashFlows=d.cashFlows;S.prices=d.prices;render();}).catch(e=>alert('è¼‰å…¥å¤±æ•—ï¼š'+e));}

function doRefreshPrices(){
  if(S.refreshing)return;
  if(S.nextRefreshTime>Date.now()){
    const sec=Math.ceil((S.nextRefreshTime-Date.now())/1000);
    showToast(`â³ è«‹ç­‰å¾… ${sec} ç§’å¾Œå†æ›´æ–°`);
    return;
  }
  S.refreshing=true;render();
  showToast('æ­£åœ¨å¾ Google Finance æŠ“å–æœ€æ–°è‚¡åƒ¹...');
  gsr('refreshPrices').then(data=>{
    S.prices=data.prices||{};
    S.priceUpdatedAt=new Date(data.timestamp).toLocaleString('zh-TW',{month:'2-digit',day:'2-digit',hour:'2-digit',minute:'2-digit'});
    S.priceSource=data.source||'Google Finance';
    S.refreshing=false;
    S.nextRefreshTime=0;
    render();
    showToast('âœ… ç¾åƒ¹å·²æ›´æ–° Â· '+S.priceSource);
  }).catch(e=>{
    S.refreshing=false;
    if(e.message&&e.message.startsWith('RATE_LIMIT:')){
      const sec=parseInt(e.message.split(':')[1]);
      S.nextRefreshTime=Date.now()+sec*1000;
      showToast(`â³ è«‹ç­‰å¾… ${sec} ç§’å¾Œå†æ›´æ–°ï¼ˆé™åˆ¶ï¼šæ¯5åˆ†é˜ä¸€æ¬¡ï¼‰`);
    }else{
      showToast('âš  æ›´æ–°å¤±æ•—ï¼Œè«‹ç¨å¾Œå†è©¦');
    }
    render();
  });
}

// âœ… åŒæ­¥ (å·²ä¿®æ­£bug)
function doSync(){if(S.syncing||!hasPendingChanges())return;S.syncing=true;render();const adds=S.pendingAddTx.map(t=>({walletId:t.walletId,symbol:t.symbol,name:t.name,type:t.type,currency:t.currency,direction:t.direction,shares:t.shares,buyPrice:t.buyPrice,limitPrice:null,fee:t.fee||0,broker:t.broker||'',date:t.date}));const addFlows=S.pendingAddFlow.map(f=>({walletId:f.walletId,type:f.type,amount:f.amount,note:f.note,date:f.date}));gsr('syncAll',{addTransactions:adds,deleteTransactions:S.pendingDelTx,addCashFlows:addFlows,deleteCashFlows:S.pendingDelFlow}).then(()=>{S.pendingAddTx=[];S.pendingDelTx=[];S.pendingAddFlow=[];S.pendingDelFlow=[];S.syncing=false;loadWalletData();showToast('âœ… åŒæ­¥å®Œæˆ');}).catch(e=>{S.syncing=false;render();alert('åŒæ­¥å¤±æ•—ï¼š'+e);});}
function showToast(msg){const el=document.createElement('div');el.className='toast';el.textContent=msg;document.getElementById('toastContainer').appendChild(el);setTimeout(()=>el.remove(),2500);}

runStartup();

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   UIé‚è¼¯å€ (UI) - æ¸²æŸ“å‡½æ•¸ã€Modalã€äº’å‹•è™•ç†
   ä¿®æ”¹é »ç‡ï¼šæœ€é«˜ï¼ˆä»‹é¢èª¿æ•´ã€åŠŸèƒ½æ–°å¢ï¼‰
   â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */

// ä¸»æ¸²æŸ“
function render(){renderWalletBar();renderNavBar();renderMobileNav();renderContent();}

function renderWalletBar(){document.getElementById('walletBar').innerHTML=S.wallets.map(w=>`<div class="wallet-tab${w.id===S.activeWalletId?' active':''}" onclick="switchWallet('${w.id}')">${esc(w.name)}${S.wallets.length>1&&w.id===S.activeWalletId?`<span class="wallet-del" onclick="event.stopPropagation();delWallet('${w.id}')">âœ•</span>`:''}</div>`).join('')+`<div class="wallet-tab" style="color:#c9a84c" onclick="newWallet()">ï¼‹</div>`;}

function renderNavBar(){const tabs=[['overview','ğŸ“Š ç¸½è¦½'],['holdings','ğŸ“ˆ æŒè‚¡'],['pnl','ğŸ’° æç›Š'],['history','ğŸ• ç´€éŒ„']];const hasChanges=hasPendingChanges();document.getElementById('navBar').innerHTML=tabs.map(([k,l])=>`<button class="nav-tab${S.tab===k?' active':''}" onclick="setTab('${k}')">${l}</button>`).join('')+`<div class="nav-right"><button class="hdr-btn${hasChanges?' has-changes':''}" onclick="doSync()" ${S.syncing||!hasChanges?'disabled':''}>${S.syncing?'â³ åŒæ­¥ä¸­':(hasChanges?`ğŸ’¾ åŒæ­¥ (${S.pendingAddTx.length+S.pendingDelTx.length+S.pendingAddFlow.length+S.pendingDelFlow.length})`:'ğŸ’¾ åŒæ­¥')}</button><button class="hdr-btn" onclick="doRefreshPrices()" ${S.refreshing?'disabled':''}>${S.refreshing?'â³ æ›´æ–°ä¸­':'ğŸ”„ æ›´æ–°ç¾åƒ¹'}</button><button class="hdr-btn rename-btn" onclick="openRename()">âœï¸ é‡å‘½å</button></div>`;}

function renderMobileNav(){const tabs=[['overview','ğŸ“Š','ç¸½è¦½'],['holdings','ğŸ“ˆ','æŒè‚¡'],['pnl','ğŸ’°','æç›Š'],['history','ğŸ•','ç´€éŒ„']];const hasChanges=hasPendingChanges();document.getElementById('mobileNav').innerHTML=tabs.map(([k,ic,l])=>`<button class="mobile-nav-btn${S.tab===k?' active':''}" onclick="setTab('${k}')"><span class="mobile-nav-icon">${ic}</span><span>${l}</span></button>`).join('')+`<button class="mobile-nav-btn${hasChanges?' active':''}" onclick="doSync()" ${S.syncing||!hasChanges?'disabled':''}><span class="mobile-nav-icon">${S.syncing?'â³':'ğŸ’¾'}</span><span>åŒæ­¥</span></button><button class="mobile-nav-btn" onclick="doRefreshPrices()" ${S.refreshing?'disabled':''}><span class="mobile-nav-icon">${S.refreshing?'â³':'ğŸ”„'}</span><span>æ›´æ–°</span></button>`;}

function renderContent(){const el=document.getElementById('mainContent');el.className='content fade-in';void el.offsetWidth;if(S.tab==='overview')el.innerHTML=renderOverview();else if(S.tab==='holdings')el.innerHTML=renderHoldings();else if(S.tab==='pnl')el.innerHTML=renderPnL();else if(S.tab==='history')el.innerHTML=renderHistory();if(S.tab==='overview')drawPie();}

function renderPriceBar(){
  const has=Object.keys(S.prices).length>0;
  const time=S.priceUpdatedAt||'å°šæœªæ›´æ–°';
  const source=S.priceSource||'Google Finance';
  const dc=S.refreshing?'dot dot-gold':has?'dot dot-green':'dot';
  const canRefresh=S.nextRefreshTime<=Date.now();
  const sec=canRefresh?0:Math.ceil((S.nextRefreshTime-Date.now())/1000);
  
  return`<div class="price-bar">
    <div class="price-bar-info">
      <div class="${dc}"></div>
      <span style="font-size:12px;color:#888">
        ${S.refreshing?'æ›´æ–°ä¸­...':(has?`${time} Â· ${source}`:'å°šæœªæ›´æ–° Â· é»å³å´æŒ‰éˆ•æ›´æ–°')}
      </span>
    </div>
    <button class="btn btn-ghost" style="padding:6px 14px;font-size:12px" onclick="doRefreshPrices()" ${S.refreshing||!canRefresh?'disabled':''}>
      ${S.refreshing?'â³ æ›´æ–°ä¸­':(canRefresh?'ğŸ”„ æ›´æ–°ç¾åƒ¹':`â³ ${sec}ç§’å¾Œå¯æ›´æ–°`)}
    </button>
  </div>`;
}

// ç¸½è¦½é 
function renderOverview(){const{totalIn,totalOut,cash}=computeStats();const hs=computeHoldings(),mkt=computeTotalMarket(hs),total=mkt+Math.max(0,cash);return`<div class="stats-grid"><div class="stat-card"><div class="stat-label">ç¸½è³‡ç”¢ï¼ˆå°å¹£ï¼‰</div><div class="stat-value gold">${fmtTWD(total)}</div></div><div class="stat-card"><div class="stat-label">ç¸½å…¥é‡‘</div><div class="stat-value green">${fmtTWD(totalIn)}</div></div><div class="stat-card"><div class="stat-label">ç¸½å‡ºé‡‘</div><div class="stat-value red">${fmtTWD(totalOut)}</div></div><div class="stat-card"><div class="stat-label">å¯å‹•ç”¨ç¾é‡‘</div><div class="stat-value ${cash>=0?'green':'red'}">${fmtTWD(cash)}</div></div></div><div class="action-bar"><button class="btn btn-gold" onclick="openAddTx()">ï¼‹ æ–°å¢äº¤æ˜“</button><button class="btn btn-ghost" onclick="openAddFlow()">ğŸ’° å‡ºå…¥é‡‘</button></div>${renderPriceBar()}${hs.length>0||cash>0?`<div class="card"><div class="card-title">è³‡ç”¢é…ç½®</div><canvas id="pieChart" style="max-height:280px"></canvas></div>`:`<div class="card"><div class="empty"><div class="empty-icon">â—ˆ</div>å…ˆæ–°å¢å‡ºå…¥é‡‘èˆ‡äº¤æ˜“ï¼Œè³‡ç”¢é…ç½®åœ–å°‡è‡ªå‹•å‡ºç¾</div></div>`}`;}

function drawPie(){
  const{cash}=computeStats(),hs=computeHoldings(),canvas=document.getElementById('pieChart');
  if(!canvas)return;
  if(pieChart){pieChart.destroy();pieChart=null;}
  const labels=[],values=[],colors=[];
  let total=0;
  hs.forEach((h,i)=>{
    const avgCost=h.totalBuyCost>0?h.totalBuyCost/Math.max(h.netShares,0.0001):0;
    const val=toTWD(avgCost*Math.abs(h.netShares)+(h.totalFees||0),h.currency);
    if(val>0){
      labels.push(h.symbol);
      values.push(Math.round(val));
      colors.push(PIE_COLORS[i%PIE_COLORS.length]);
      total+=val;
    }
  });
  if(cash>0){
    labels.push('å¯å‹•ç”¨ç¾é‡‘');
    values.push(Math.round(cash));
    colors.push('#666');
    total+=cash;
  }
  if(!values.length)return;
  
  // è¨ˆç®—æ¯”ä¾‹ä¸¦åŠ å…¥æ¨™ç±¤
  const labelsWithPercent=labels.map((label,i)=>{
    const percent=((values[i]/total)*100).toFixed(1);
    return `${label} (${percent}%)`;
  });
  
  pieChart=new Chart(canvas,{
    type:'doughnut',
    data:{labels:labelsWithPercent,datasets:[{data:values,backgroundColor:colors,borderWidth:2,borderColor:'#1a1e28'}]},
    options:{
      responsive:true,
      maintainAspectRatio:true,
      plugins:{
        legend:{
          labels:{color:'#ccc',font:{size:13,family:'-apple-system,BlinkMacSystemFont,"Segoe UI","Noto Sans",Helvetica,Arial,sans-serif'},padding:16}
        },
        tooltip:{
          callbacks:{label:ctx=>{
            const percent=((ctx.raw/total)*100).toFixed(1);
            return ` ${ctx.label.split(' (')[0]}: ${fmtTWD(ctx.raw)} (${percent}%)`;
          }},
          backgroundColor:'#1a1e28',
          borderColor:'#2a2e3e',
          borderWidth:1,
          titleColor:'#c9a84c',
          bodyColor:'#ccc',
          titleFont:{size:13},
          bodyFont:{size:13}
        }
      }
    }
  });
}

// æŒè‚¡é ï¼ˆå¡ç‰‡ï¼‰
function renderHoldings(){const hs=computeHoldings();if(!hs.length)return`<div class="action-bar"><button class="btn btn-gold" onclick="openAddTx()">ï¼‹ æ–°å¢äº¤æ˜“</button></div><div class="card"><div class="empty"><div class="empty-icon">ğŸ“ˆ</div>å°šç„¡æŒè‚¡ç´€éŒ„</div></div>`;const cards=hs.map(h=>{const isShort=h.netShares<0;const avgCost=(h.totalBuyCost>0&&h.netShares>0)?(h.totalBuyCost+h.totalFees)/h.netShares:0;const costVal=avgCost>0?avgCost*Math.abs(h.netShares):null;const curPrice=getPrice(h.symbol);const mktVal=curPrice?curPrice*Math.abs(h.netShares):costVal;const pnl=curPrice&&costVal?(mktVal-costVal):null;const pnlRate=curPrice&&avgCost>0?((curPrice-avgCost)/avgCost*100):null;const pnlColor=pnl>0?'color:#4caf82':(pnl<0?'color:#f06060':'');return`<div class="holding-card${h.pending?' pending':''}"><div class="hc-header"><div style="flex:1;min-width:0"><div class="hc-symbol">${esc(h.symbol)}</div><div class="hc-name">${esc(h.name)}</div></div><div class="hc-tags"><span class="tag tag-${h.type}">${TYPE_LBL[h.type]}</span>${isShort?'<span class="tag tag-sell">ç©ºé ­</span>':'<span class="tag tag-buy">å¤šé ­</span>'}${h.pending?'<span class="tag tag-pending">æœªåŒæ­¥</span>':''}</div></div><div class="hc-body"><div class="hc-field"><div class="hc-label">æ·¨æŒè‚¡</div><div class="hc-value" style="${isShort?'color:#f06060':''}">${isShort?'-':''}${Math.abs(h.netShares).toLocaleString()}</div></div><div class="hc-field"><div class="hc-label">å¹³å‡æˆæœ¬</div><div class="hc-value">${avgCost>0?fmtCur(avgCost.toFixed(2),h.currency):'â€”'}</div></div>${curPrice?`<div class="hc-field"><div class="hc-label">ç¾åƒ¹${S.priceUpdatedAt?' ('+ S.priceUpdatedAt+')':''}</div><div class="hc-value">${fmtCur(curPrice,h.currency)}</div></div><div class="hc-field"><div class="hc-label">å ±é…¬ç‡</div><div class="hc-value" style="${pnlColor}">${pnlRate!==null?(pnlRate>=0?'+':'')+pnlRate.toFixed(2)+'%':'â€”'}</div></div>`:`<div class="hc-field"><div class="hc-label">æˆæœ¬å¸‚å€¼</div><div class="hc-value" style="color:#888">${costVal?fmtCur(costVal.toFixed(0),h.currency):'â€”'}</div></div><div class="hc-field"><div class="hc-label"></div><div class="hc-value"></div></div>`}</div><div class="hc-footer"><div style="font-size:12px;color:#555">${mktVal?`å¸‚å€¼ ${fmtTWD(toTWD(mktVal,h.currency))}`:''}${pnl?` Â· æç›Š `:''}${pnl?`<span style="${pnlColor}">${pnl>=0?'+':''}${fmtCur(pnl.toFixed(0),h.currency)}</span>`:''}</div></div></div>`;}).join('');return`<div class="action-bar"><button class="btn btn-gold" onclick="openAddTx()">ï¼‹ æ–°å¢äº¤æ˜“</button></div>${renderPriceBar()}<div class="card"><div class="card-title">ç¾æœ‰æŒè‚¡</div><div class="holdings-grid">${cards}</div></div>`;}

// æ­·å²é 
function renderHistory(){const items=getRecent30();const rows=items.map(item=>{if(item._kind==='tx'){const tot=item.buyPrice*item.shares,dir=item.direction||'buy';return`<div class="history-item${item._pending?' pending':''}"><div class="h-left"><div class="h-icon">${dir==='buy'?'ğŸ“ˆ':'ğŸ“‰'}</div><div><div style="display:flex;align-items:center;gap:0.4rem;flex-wrap:wrap"><strong>${esc(item.symbol)}</strong><span class="tag tag-${item.type}">${TYPE_LBL[item.type]}</span><span class="tag tag-${dir}">${DIR_LBL[dir]}</span>${item._pending?'<span class="tag tag-pending">æœªåŒæ­¥</span>':''}</div><div class="h-sub">${esc(item.name)} Â· ${item.shares} è‚¡ Ã— ${fmtCur(item.buyPrice,item.currency)}</div><div class="h-date">${item.date}</div></div></div><div class="h-right"><div><div style="font-weight:bold;font-size:13px;color:${dir==='sell'?'#f06060':'#e8e0d0'}">${dir==='sell'?'-':''}${fmtCur(tot.toFixed(0),item.currency)}</div><div class="h-twd">${fmtTWD(toTWD(tot,item.currency))}</div></div><button class="btn-del" onclick="delTx('${item.id}')">ğŸ—‘</button></div></div>`;}else{return`<div class="history-item${item._pending?' pending':''}"><div class="h-left"><div class="h-icon">${item.type==='in'?'ğŸ’µ':'ğŸ“¤'}</div><div><div style="display:flex;align-items:center;gap:0.4rem;flex-wrap:wrap"><strong>${item.type==='in'?'å…¥é‡‘':'å‡ºé‡‘'}</strong><span class="tag tag-${item.type}">${item.type==='in'?'â–² å…¥é‡‘':'â–¼ å‡ºé‡‘'}</span>${item._pending?'<span class="tag tag-pending">æœªåŒæ­¥</span>':''}</div>${item.note?`<div class="h-sub">${esc(item.note)}</div>`:''}<div class="h-date">${item.date}</div></div></div><div class="h-right"><div style="font-weight:bold;font-size:14px;color:${item.type==='in'?'#4caf82':'#f06060'}">${item.type==='in'?'+':'âˆ’'}${fmtTWD(item.amount)}</div><button class="btn-del" onclick="delFlow('${item.id}')">ğŸ—‘</button></div></div>`;}}).join('');return`<div class="action-bar"><button class="btn btn-gold" onclick="openAddTx()">ï¼‹ æ–°å¢äº¤æ˜“</button><button class="btn btn-ghost" onclick="openAddFlow()">ğŸ’° å‡ºå…¥é‡‘</button></div><div class="card"><div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:16px"><div class="card-title" style="margin:0">è¿‘ 30 æ—¥ç´€éŒ„</div><div style="font-size:12px;color:#555">${items.length} ç­†</div></div>${items.length?rows:'<div class="empty"><div class="empty-icon">ğŸ•</div>è¿‘ 30 æ—¥ç„¡ç´€éŒ„</div>'}</div>`;}

// å·²å¯¦ç¾æç›Šé 
function renderPnL(){
  const years=[];
  const currentYear=new Date().getFullYear();
  for(let y=currentYear;y>=currentYear-5;y--)years.push(y);
  const months=[{v:'all',l:'å…¨å¹´'},...Array.from({length:12},(_,i)=>({v:i+1,l:`${i+1}æœˆ`}))];
  
  const pnl=computeRealizedPnL(S.pnlYear,S.pnlMonth);
  
  const rows=pnl.trades.map(t=>{
    const color=t.pnl>=0?'color:#4caf82':'color:#f06060';
    return`<div class="history-item">
      <div class="h-left"><div class="h-icon">${t.pnl>=0?'âœ…':'âŒ'}</div><div>
        <div style="display:flex;align-items:center;gap:0.4rem;flex-wrap:wrap">
          <strong>${esc(t.symbol)}</strong>
          <span class="tag tag-sell">å¹³å€‰</span>
        </div>
        <div class="h-sub">${t.qty} è‚¡ Â· è²· ${fmtCur(t.buyPrice,t.currency,false)} â†’ è³£ ${fmtCur(t.sellPrice,t.currency,false)}</div>
        <div class="h-date">è²·å…¥ ${t.buyDate} â†’ è³£å‡º ${t.date}</div>
      </div></div>
      <div class="h-right">
        <div><div style="font-weight:bold;font-size:13px;${color}">${t.pnl>=0?'+':''}${fmtCur(t.pnl.toFixed(2),t.currency)}</div><div class="h-twd">${t.pnlTWD>=0?'+':''}${fmtTWD(t.pnlTWD)}</div></div>
      </div>
    </div>`;
  }).join('');
  
  return`
    <div class="card">
      <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:16px;flex-wrap:wrap;gap:0.65rem">
        <div class="card-title" style="margin:0">ğŸ’° å·²å¯¦ç¾æç›Š</div>
        <div style="display:flex;gap:0.5rem">
          <select class="input" style="width:auto;padding:6px 10px;font-size:13px" onchange="S.pnlYear=this.value;render()">
            ${years.map(y=>`<option value="${y}" ${S.pnlYear==y?'selected':''}>${y}å¹´</option>`).join('')}
          </select>
          <select class="input" style="width:auto;padding:6px 10px;font-size:13px" onchange="S.pnlMonth=this.value;render()">
            ${months.map(m=>`<option value="${m.v}" ${S.pnlMonth==m.v?'selected':''}>${m.l}</option>`).join('')}
          </select>
        </div>
      </div>
      <div class="stats-grid" style="margin-bottom:16px">
        <div class="stat-card"><div class="stat-label">ç¸½æç›Šï¼ˆå°å¹£ï¼‰</div><div class="stat-value ${pnl.totalPnL>=0?'green':'red'}">${pnl.totalPnL>=0?'+':''}${fmtTWD(pnl.totalPnL)}</div></div>
        <div class="stat-card"><div class="stat-label">äº¤æ˜“æ¬¡æ•¸</div><div class="stat-value gold">${pnl.total} ç­†</div></div>
        <div class="stat-card"><div class="stat-label">å‹ç‡</div><div class="stat-value ${pnl.winRate>=50?'green':'red'}">${pnl.winRate.toFixed(1)}%</div></div>
        <div class="stat-card"><div class="stat-label">ç²åˆ©/è™§æ</div><div class="stat-value">${pnl.wins} / ${pnl.losses}</div></div>
      </div>
      ${pnl.trades.length?rows:'<div class="empty"><div class="empty-icon">ğŸ’°</div>æ‰€é¸æœŸé–“ç„¡å·²å¯¦ç¾æç›Šç´€éŒ„</div>'}
    </div>`;
}

// æ­·å²é 

// Modal
function showModal(html){document.getElementById('modalContainer').innerHTML=html;}
function closeModal(){document.getElementById('modalContainer').innerHTML='';}

// âœ… æ–°å¢äº¤æ˜“ Modal (å·²ç§»é™¤é™åƒ¹ï¼Œä¸è‡ªå‹•å¸¶åƒ¹)
function openAddTx(){S.txDirection='buy';S.txSelected=null;S.txSearching=false;S.txSearchResults=[];S.txSymbolInput='';S.txShares='';S.txPrice='';S.txFee='';S.txBroker='';S.txDate=today();renderTxModal();}

function renderTxModal(){const d=S.txDirection,canSubmit=S.txSelected&&S.txShares&&S.txPrice;let symSection='';if(S.txSelected){symSection=`<div class="sym-selected"><div class="sym-selected-info"><span class="tag tag-${S.txSelected.type}">${TYPE_LBL[S.txSelected.type]}</span><strong style="font-size:14px">${esc(S.txSelected.symbol)}</strong><span style="color:#888;font-size:12px">${esc(S.txSelected.name)}</span></div><button class="sym-clear" onclick="clearSymbol()">âœ•</button></div>`;}else{let dropdown='';if(S.txSearching)dropdown=`<div class="sym-dropdown"><div class="sym-no-result" style="display:flex;align-items:center;justify-content:center;gap:0.5rem"><div class="spinner"></div> æœå°‹ä¸­ï¼ˆç´„3ç§’ï¼‰...</div></div>`;else if(S.txSearchResults.length>0)dropdown=`<div class="sym-dropdown">`+S.txSearchResults.map((r,i)=>`<div class="sym-item" onclick="selectSymbol(${i})"><div class="sym-item-left"><span class="sym-item-symbol">${esc(r.symbol)}</span><span class="tag tag-${r.type}">${TYPE_LBL[r.type]}</span><span class="sym-item-name">${esc(r.name)}</span></div><div class="sym-item-right">${r.price?`<span class="sym-item-price">${fmtCur(r.price,r.currency)}</span>`:''}<span style="color:#555;font-size:12px">é¸æ“‡ â†’</span></div></div>`).join('')+`</div>`;else if(S.txSymbolInput&&!S.txSearching)dropdown=`<div class="sym-dropdown"><div class="sym-no-result">æ‰¾ä¸åˆ°ã€Œ${esc(S.txSymbolInput)}ã€</div></div>`;symSection=`<div class="sym-wrap"><div class="sym-input-row"><input class="input" id="symInput" placeholder="è¼¸å…¥ä»£è™Ÿå¾ŒæŒ‰ Enter æˆ–é»æœå°‹" value="${esc(S.txSymbolInput)}" oninput="S.txSymbolInput=this.value" onkeydown="if(event.key==='Enter'){event.preventDefault();doSymSearch()}" autofocus><button class="sym-search-btn" onclick="doSymSearch()" ${S.txSearching?'disabled':''}>${S.txSearching?'â³':'ğŸ” æœå°‹'}</button></div><div class="sym-status" style="font-size:12px;color:#555">${S.txSearching?'':(S.txSymbolInput?'':'æ”¯æ´ï¼šå°è‚¡ä»£è™Ÿï¼ˆ2330ï¼‰ã€ç¾è‚¡ï¼ˆAAPLï¼‰ã€åŠ å¯†è²¨å¹£ï¼ˆBTCï¼‰')}</div>${dropdown}</div>`;}const preview=S.txSelected&&S.txShares&&S.txPrice?`<div class="preview-box"><span style="color:#888">${d==='buy'?'èŠ±è²»':'è³£å‡ºé‡‘é¡'}ï¼š</span><span class="${d==='buy'?'gold':'red'}">${fmtCur((S.txPrice*S.txShares).toFixed(0),S.txSelected.currency)}</span><span style="color:#555"> â‰ˆ ${fmtTWD(toTWD(S.txPrice*S.txShares,S.txSelected.currency))}</span></div>`:'';showModal(`<div class="modal-bg" onclick="closeModal()"><div class="modal" onclick="event.stopPropagation()"><div class="modal-title">æ–°å¢äº¤æ˜“</div><div class="toggle-row"><button class="toggle-btn ${d==='buy'?'active-buy':''}" onclick="S.txDirection='buy';renderTxModal()">ğŸ“ˆ è²·å…¥</button><button class="toggle-btn ${d==='sell'?'active-sell':''}" onclick="S.txDirection='sell';renderTxModal()">ğŸ“‰ è³£å‡º</button></div><div class="field"><div class="field-label">è‚¡ç¥¨ä»£è™Ÿ / åŠ å¯†è²¨å¹£</div>${symSection}</div><div class="grid-2"><div class="field"><div class="field-label">è‚¡æ•¸ / æ•¸é‡</div><input class="input" type="number" placeholder="0" value="${S.txShares}" oninput="S.txShares=this.value;updateTxPreview()"></div><div class="field"><div class="field-label">${d==='buy'?'è²·å…¥':'è³£å‡º'}åƒ¹æ ¼ï¼ˆ${S.txSelected?.currency||'å¹£åˆ¥'}ï¼‰</div><input class="input" type="number" placeholder="0.00" value="${S.txPrice}" oninput="S.txPrice=this.value;updateTxPreview()"></div></div><div class="grid-2"><div class="field"><div class="field-label">æ‰‹çºŒè²»ï¼ˆé¸å¡«ï¼Œ${S.txSelected?.currency||'å¹£åˆ¥'}ï¼‰</div><input class="input" type="number" placeholder="0.00" value="${S.txFee}" oninput="S.txFee=this.value;updateTxPreview()"></div><div class="field"><div class="field-label">åˆ¸å•†/äº¤æ˜“æ‰€ï¼ˆé¸å¡«ï¼‰</div><input class="input" type="text" placeholder="ä¾‹ï¼šå‡±åŸºã€åœ‹æ³°..." value="${S.txBroker}" oninput="S.txBroker=this.value"></div></div><div class="field"><div class="field-label">æ—¥æœŸ</div><input class="input" type="date" value="${S.txDate}" oninput="S.txDate=this.value"></div><div id="txPreview">${preview}</div><div class="modal-actions"><button class="btn btn-gold" style="flex:1" id="txSubmitBtn" onclick="submitTx()" ${canSubmit?'':'disabled'}>ç¢ºèªæ–°å¢</button><button class="btn btn-ghost" onclick="closeModal()">å–æ¶ˆ</button></div></div></div>`);}

function doSymSearch(){const val=(document.getElementById('symInput')?.value||S.txSymbolInput).trim();S.txSymbolInput=val;if(!val)return;S.txSearching=true;S.txSearchResults=[];renderTxModal();gsr('searchSymbol',val).then(res=>{S.txSearching=false;S.txSearchResults=res.results||[];renderTxModal();}).catch(()=>{S.txSearching=false;S.txSearchResults=[];renderTxModal();});}

// âœ… é¸æ“‡è‚¡ç¥¨ä¸å¸¶å…¥åƒ¹æ ¼
function selectSymbol(i){S.txSelected=S.txSearchResults[i];S.txSearchResults=[];renderTxModal();}

function clearSymbol(){S.txSelected=null;S.txSearchResults=[];S.txSymbolInput='';S.txPrice='';renderTxModal();}

function updateTxPreview(){const box=document.getElementById('txPreview'),btn=document.getElementById('txSubmitBtn');if(box&&S.txSelected&&S.txShares&&S.txPrice){const d=S.txDirection;const fee=parseFloat(S.txFee)||0;const subtotal=S.txPrice*S.txShares;const total=subtotal+fee;box.innerHTML=`<div class="preview-box"><span style="color:#888">${d==='buy'?'èŠ±è²»':'è³£å‡ºé‡‘é¡'}ï¼š</span><span class="${d==='buy'?'gold':'red'}">${fmtCur(subtotal.toFixed(2),S.txSelected.currency)}</span>${fee>0?` <span style="color:#888">+ æ‰‹çºŒè²» ${fmtCur(fee.toFixed(2),S.txSelected.currency)} = ${fmtCur(total.toFixed(2),S.txSelected.currency)}</span>`:''}<span style="color:#555"> â‰ˆ ${fmtTWD(toTWD(total,S.txSelected.currency))}</span></div>`;}if(btn)btn.disabled=!(S.txSelected&&S.txShares&&S.txPrice);}

function submitTx(){if(!S.txSelected||!S.txShares||!S.txPrice)return;const newTx={id:'temp_'+Date.now(),_pending:true,walletId:S.activeWalletId,symbol:S.txSelected.symbol,name:S.txSelected.name,type:S.txSelected.type,currency:S.txSelected.currency,direction:S.txDirection,shares:parseFloat(S.txShares),buyPrice:parseFloat(S.txPrice),fee:parseFloat(S.txFee)||0,broker:S.txBroker||'',date:S.txDate};S.transactions.push(newTx);S.pendingAddTx.push(newTx);closeModal();render();showToast('âœ… å·²åŠ å…¥å¾…åŒæ­¥ï¼Œè«‹é»å³ä¸Šã€ŒåŒæ­¥ã€æŒ‰éˆ•å„²å­˜');}

// å‡ºå…¥é‡‘ Modal
function openAddFlow(){S.flowForm={type:'in',amount:'',note:'',isDividend:false,date:today()};renderFlowModal();}
function renderFlowModal(){const f=S.flowForm;showModal(`<div class="modal-bg" onclick="closeModal()"><div class="modal" onclick="event.stopPropagation()"><div class="modal-title">å‡ºå…¥é‡‘ç´€éŒ„</div><div class="toggle-row"><button class="toggle-btn ${f.type==='in'?'active-buy':''}" onclick="S.flowForm.type='in';renderFlowModal()">ğŸ’µ å…¥é‡‘</button><button class="toggle-btn ${f.type==='out'?'active-sell':''}" onclick="S.flowForm.type='out';renderFlowModal()">ğŸ“¤ å‡ºé‡‘</button></div><div class="field"><div class="field-label">é‡‘é¡ï¼ˆå°å¹£ï¼‰</div><input class="input" type="number" placeholder="0" value="${f.amount}" oninput="S.flowForm.amount=this.value" autofocus></div><div class="field"><div class="field-label">å‚™æ³¨ï¼ˆé¸å¡«ï¼‰</div><input class="input" placeholder="ä¾‹ï¼šè–ªæ°´ã€ææ¬¾..." value="${f.note}" oninput="S.flowForm.note=this.value"></div>${f.type==='in'?`<div class="field"><label style="display:flex;align-items:center;gap:0.5rem;cursor:pointer;font-size:14px"><input type="checkbox" ${f.isDividend?'checked':''} onchange="S.flowForm.isDividend=this.checked;renderFlowModal()" style="width:18px;height:18px;cursor:pointer"><span>é€™æ˜¯è‚¡æ¯/é…æ¯æ”¶å…¥</span></label></div>`:''}<div class="field"><div class="field-label">æ—¥æœŸ</div><input class="input" type="date" value="${f.date}" oninput="S.flowForm.date=this.value"></div><div class="modal-actions"><button class="btn btn-gold" style="flex:1" onclick="submitFlow()">ç¢ºèª</button><button class="btn btn-ghost" onclick="closeModal()">å–æ¶ˆ</button></div></div></div>`);}
function submitFlow(){if(!S.flowForm.amount)return;let note=S.flowForm.note;if(S.flowForm.isDividend&&S.flowForm.type==='in'){note=(note?note+' ':'')+'[é…æ¯]';}const newFlow={id:'temp_'+Date.now(),_pending:true,walletId:S.activeWalletId,type:S.flowForm.type,amount:parseFloat(S.flowForm.amount),note:note,date:S.flowForm.date};S.cashFlows.push(newFlow);S.pendingAddFlow.push(newFlow);closeModal();render();showToast('âœ… å·²åŠ å…¥å¾…åŒæ­¥ï¼Œè«‹é»å³ä¸Šã€ŒåŒæ­¥ã€æŒ‰éˆ•å„²å­˜');}

// åˆªé™¤
function delTx(id){if(!confirm('ç¢ºå®šåˆªé™¤æ­¤äº¤æ˜“ï¼Ÿ'))return;if(id.startsWith('temp_')){S.transactions=S.transactions.filter(t=>t.id!==id);S.pendingAddTx=S.pendingAddTx.filter(t=>t.id!==id);}else{S.transactions=S.transactions.filter(t=>t.id!==id);S.pendingDelTx.push(id);}render();}
function delFlow(id){if(!confirm('ç¢ºå®šåˆªé™¤æ­¤ç´€éŒ„ï¼Ÿ'))return;if(id.startsWith('temp_')){S.cashFlows=S.cashFlows.filter(f=>f.id!==id);S.pendingAddFlow=S.pendingAddFlow.filter(f=>f.id!==id);}else{S.cashFlows=S.cashFlows.filter(f=>f.id!==id);S.pendingDelFlow.push(id);}render();}

// éŒ¢åŒ…æ“ä½œ
function openRename(){const w=S.wallets.find(w=>w.id===S.activeWalletId);S.renameVal=w?w.name:'';showModal(`<div class="modal-bg" onclick="closeModal()"><div class="modal" style="max-width:20rem" onclick="event.stopPropagation()"><div class="modal-title">é‡å‘½åéŒ¢åŒ…</div><input class="input" value="${esc(S.renameVal)}" oninput="S.renameVal=this.value" onkeydown="if(event.key==='Enter')submitRename()" style="margin-bottom:16px" autofocus><div class="modal-actions"><button class="btn btn-gold" style="flex:1" onclick="submitRename()">ç¢ºèª</button><button class="btn btn-ghost" onclick="closeModal()">å–æ¶ˆ</button></div></div></div>`);}
function submitRename(){if(!S.renameVal.trim())return;gsr('renameWallet',S.activeWalletId,S.renameVal).then(()=>{S.wallets=S.wallets.map(w=>w.id===S.activeWalletId?{...w,name:S.renameVal}:w);closeModal();render();});}
function switchWallet(id){if(id===S.activeWalletId)return;if(hasPendingChanges()&&!confirm('åˆ‡æ›éŒ¢åŒ…å°‡æ¸…é™¤æœªåŒæ­¥çš„è³‡æ–™ï¼Œç¢ºå®šç¹¼çºŒï¼Ÿ'))return;S.activeWalletId=id;S.pendingAddTx=[];S.pendingDelTx=[];S.pendingAddFlow=[];S.pendingDelFlow=[];loadWalletData();}
function newWallet(){const name=prompt('æ–°éŒ¢åŒ…åç¨±ï¼š','æ–°éŒ¢åŒ…');if(!name)return;gsr('addWallet',name).then(id=>{S.wallets.push({id,name});switchWallet(id);});}
function delWallet(id){if(!confirm('ç¢ºå®šåˆªé™¤æ­¤éŒ¢åŒ…åŠæ‰€æœ‰ç›¸é—œè³‡æ–™ï¼Ÿ'))return;gsr('deleteWallet',id).then(()=>{S.wallets=S.wallets.filter(w=>w.id!==id);S.activeWalletId=S.wallets[0].id;loadWalletData();});}

// DB Detail Modal
function openDbDetail(){if(!S.dbInfo){showToast('å°šç„¡è³‡æ–™åº«è³‡è¨Š');return;}const db=S.dbInfo,rows=SHEETS_ORDER.map(name=>{const info=db.sheets[name],badge=info&&info.rows>0?`<span class="db-badge-rows">${info.rows} ç­†</span>`:`<span class="db-badge-ok">ç©ºç™½</span>`;return`<div class="db-detail-row"><span style="color:#aaa;font-size:13px">${SHEET_META[name].icon} ${SHEET_META[name].label}</span>${badge}</div>`;}).join('');showModal(`<div class="modal-bg" onclick="closeModal()"><div class="db-detail" onclick="event.stopPropagation()"><div style="font-size:15px;color:#c9a84c;margin-bottom:4px">â—ˆ è³‡æ–™åº«ç‹€æ…‹</div><div style="font-size:12px;color:#555;margin-bottom:20px">${esc(db.spreadsheetName)}</div>${rows}<div style="display:flex;gap:1rem;margin-top:20px;padding-top:16px;border-top:1px solid #2a2e3e"><div style="flex:1;text-align:center"><div style="font-size:18px;color:#c9a84c">${db.walletCount}</div><div style="font-size:12px;color:#555;margin-top:2px">éŒ¢åŒ…</div></div><div style="flex:1;text-align:center"><div style="font-size:18px;color:#c9a84c">${db.transactionCount}</div><div style="font-size:12px;color:#555;margin-top:2px">äº¤æ˜“</div></div><div style="flex:1;text-align:center"><div style="font-size:18px;color:#c9a84c">${db.cashFlowCount}</div><div style="font-size:12px;color:#555;margin-top:2px">å‡ºå…¥é‡‘</div></div></div><button class="btn btn-ghost" style="width:100%;margin-top:20px" onclick="closeModal()">é—œé–‰</button></div></div>`);}

function setTab(tab){S.tab=tab;render();}

// è¦–åœ–æ¨¡å¼åˆ‡æ›
function toggleViewMode(){
  const html = document.documentElement;
  const isMobileNow = html.classList.contains('is-mobile');
  
  html.classList.remove('is-mobile','is-tablet','is-desktop');
  
  if(isMobileNow){
    html.classList.add('is-desktop');
    localStorage.setItem('forceViewMode','desktop');
    showToast('å·²åˆ‡æ›åˆ°æ¡Œé¢ç‰ˆ');
  }else{
    html.classList.add('is-mobile');
    localStorage.setItem('forceViewMode','mobile');
    showToast('å·²åˆ‡æ›åˆ°æ‰‹æ©Ÿç‰ˆ');
  }
  
  updateViewModeIcon();
  render();
}

function updateViewModeIcon(){
  const icon = document.getElementById('viewModeIcon');
  if(!icon) return;
  const html = document.documentElement;
  if(html.classList.contains('is-mobile')){
    icon.textContent = 'ğŸ“±';
    icon.parentElement.title = 'ç›®å‰ï¼šæ‰‹æ©Ÿç‰ˆï¼ˆé»æ“Šåˆ‡æ›åˆ°æ¡Œé¢ç‰ˆï¼‰';
  }else{
    icon.textContent = 'ğŸ’»';
    icon.parentElement.title = 'ç›®å‰ï¼šæ¡Œé¢ç‰ˆï¼ˆé»æ“Šåˆ‡æ›åˆ°æ‰‹æ©Ÿç‰ˆï¼‰';
  }
}
</script>

<!-- PWA Service Worker è¨»å†Š -->
<script>
// è¨»å†Š Service Worker
if ('serviceWorker' in navigator) {
  window.addEventListener('load', () => {
    navigator.serviceWorker.register('/sw.js')
      .then(registration => {
        console.log('âœ… Service Worker è¨»å†ŠæˆåŠŸ:', registration.scope);
        
        // æª¢æŸ¥æ›´æ–°
        registration.addEventListener('updatefound', () => {
          const newWorker = registration.installing;
          console.log('ğŸ”„ ç™¼ç¾ Service Worker æ›´æ–°');
          
          newWorker.addEventListener('statechange', () => {
            if (newWorker.state === 'installed' && navigator.serviceWorker.controller) {
              // æœ‰æ–°ç‰ˆæœ¬å¯ç”¨
              if (confirm('AURUM æœ‰æ–°ç‰ˆæœ¬å¯ç”¨ï¼Œæ˜¯å¦ç«‹å³æ›´æ–°ï¼Ÿ')) {
                newWorker.postMessage({ type: 'SKIP_WAITING' });
                window.location.reload();
              }
            }
          });
        });
      })
      .catch(error => {
        console.log('âŒ Service Worker è¨»å†Šå¤±æ•—:', error);
      });
  });
  
  // ç›£è½ Service Worker æ§åˆ¶æ¬Šè®Šæ›´
  let refreshing = false;
  navigator.serviceWorker.addEventListener('controllerchange', () => {
    if (!refreshing) {
      refreshing = true;
      window.location.reload();
    }
  });
}

// PWA å®‰è£æç¤º
let deferredPrompt;
window.addEventListener('beforeinstallprompt', (e) => {
  console.log('ğŸ’¡ å¯ä»¥å®‰è£ PWA');
  e.preventDefault();
  deferredPrompt = e;
  
  // é¡¯ç¤ºå®‰è£æç¤ºï¼ˆå¯é¸ï¼‰
  // æ‚¨å¯ä»¥åœ¨é©ç•¶æ™‚æ©Ÿé¡¯ç¤ºè‡ªè¨‚çš„å®‰è£æŒ‰éˆ•
});

// å®‰è£æˆåŠŸäº‹ä»¶
window.addEventListener('appinstalled', () => {
  console.log('âœ… PWA å·²å®‰è£');
  deferredPrompt = null;
});
</script>
</body>
</html>
